name: Deploy to Oracle ADB

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TNS_ADMIN: ${{ github.workspace }}/Wallet_APEXDEVDB
      DB_ALIAS: apexdevdb_high
      DB_USER: GTIM
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      SQLCL_DIR: ${{ github.workspace }}/sqlcl
      OJDBC_DIR: ${{ github.workspace }}/ojdbc

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install SQLcl
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip wget
        wget --no-cookies --no-check-certificate \
             --header "Cookie: oraclelicense=accept-securebackup-cookie" \
             https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip -O sqlcl.zip
        unzip -q sqlcl.zip -d sqlcl
      shell: bash  
      
    - name: Install LB
      run: |
        curl -LO https://github.com/liquibase/liquibase/releases/download/v4.29.2/liquibase-4.29.2.zip
        unzip liquibase-*.zip -d $HOME/liquibase
        echo "$HOME/liquibase" >> $GITHUB_PATH      

    - name: Download and unzip Wallet
      run: |
        mkdir -p "${TNS_ADMIN}"
        unzip -o Wallet_APEXDEVDB.zip -d "${TNS_ADMIN}"
      shell: bash

    - name: Download Oracle JDBC + PKI jars
      run: |
        mkdir -p "${OJDBC_DIR}"
        curl -L -o "${OJDBC_DIR}/ojdbc8.jar" https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc8/21.9.0.0/ojdbc8-21.9.0.0.jar
        curl -L -o "${OJDBC_DIR}/oraclepki.jar" https://repo1.maven.org/maven2/com/oracle/database/security/oraclepki/21.9.0.0/oraclepki-21.9.0.0.jar
        curl -L -o "${OJDBC_DIR}/osdt_core.jar" https://repo1.maven.org/maven2/com/oracle/database/security/osdt_core/21.9.0.0/osdt_core-21.9.0.0.jar
        curl -L -o "${OJDBC_DIR}/osdt_cert.jar" https://repo1.maven.org/maven2/com/oracle/database/security/osdt_cert/21.9.0.0/osdt_cert-21.9.0.0.jar
      env:
         OJDBC_DIR: ${{ github.workspace }}/ojdbc
      shell: bash

    - name: Run Liquibase update on Oracle ADB
      run: |
        liquibase \
          --driver=oracle.jdbc.OracleDriver \
          --url="jdbc:oracle:thin:@(description=(retry_count=20)(retry_delay=3)(address=(protocol=tcps)(port=1522)(host=adb.us-phoenix-1.oraclecloud.com))(connect_data=(service_name=g715fad23c28830_apexdevdb_high.adb.oraclecloud.com))(security=(ssl_server_dn_match=yes)))" \
          --username=${DB_USER} \
          --password=${DB_PASSWORD} \
          --changeLogFile=changelog_001.sql \
          update \          
      env:
        TNS_ADMIN: ${{ github.workspace }}/Wallet_APEXDEVDB
        DB_ALIAS: apexdevdb_high
        DB_USER: GTIM
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        SQLCL_DIR: ${{ github.workspace }}/sqlcl
        OJDBC_DIR: ${{ github.workspace }}/ojdbc
        
